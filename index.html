<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>스토어</title>
  <meta name="description" content="Firestore 상품/주문 + 설정(상호/사업자정보) 반영" />
  <style>
    :root{
      --bg:#f8fafc; --text:#0f172a; --muted:#64748b;
      --card:#ffffff; --border:#e2e8f0;
      --accent:#2563eb; --accent-2:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;color:var(--text);background:var(--bg)}
    a{color:inherit;text-decoration:none}
    .container{max-width:1120px;margin:0 auto;padding:0 16px}
    header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .nav{display:flex;align-items:center;justify-content:space-between;min-height:64px}
    .brand{font-weight:800;font-size:18px}
    .toolbar{display:flex;gap:10px;align-items:center}
    .btn{border:1px solid var(--border);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.ghost{background:#fff;color:var(--text)}
    .btn.link{background:transparent;border:0;color:var(--accent);font-weight:700;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:16px;padding:24px 0}
    @media (min-width:580px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:920px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .thumb{aspect-ratio:16/11;display:grid;place-items:center;background:#f1f5f9;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .pill{position:absolute;top:10px;left:10px;background:#0f172a10;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
    .content{padding:12px 14px 16px}
    .title{font-weight:800;margin:0 0 6px}
    .price{font-weight:900;margin-top:6px}
    .section{padding:40px 0}
    .empty{color:var(--muted);padding:24px;text-align:center}
    footer{border-top:1px solid var(--border);background:#fff;color:var(--muted)}
    .footbar{display:flex;flex-direction:column;gap:8px;padding:18px 0}
    /* Drawer */
    .drawer{position:fixed;top:0;right:-420px;width:min(420px,100vw);height:100vh;background:#fff;border-left:1px solid var(--border);transition:right .3s;z-index:50;display:flex;flex-direction:column}
    .drawer.open{right:0}
    .drawer header{padding:16px;border-bottom:1px solid var(--border);font-weight:800}
    .drawer .body{flex:1;overflow:auto;padding:0 16px}
    .drawer .foot{padding:16px;border-top:1px solid var(--border)}
    /* MyPage Orders */
    .order-group{margin:18px 0}
    .order-date{font-weight:800; margin:12px 0 8px; color:#0f172a}
    .order-card{background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:16px}
    .order-head{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border)}
    .order-head .status{color:#64748b; font-weight:700}
    .order-head .order-no{color:#334155; font-weight:800}
    .order-body{padding:12px 16px}
    .order-item{display:grid; grid-template-columns:72px 1fr; gap:12px; align-items:center; padding:10px 0; border-bottom:1px solid var(--border)}
    .order-item:last-child{border-bottom:0}
    .order-thumb{width:72px; height:72px; border-radius:10px; background:#f1f5f9; display:grid; place-items:center; overflow:hidden; border:1px solid var(--border)}
    .order-thumb img{width:100%; height:100%; object-fit:cover}
    .order-title{font-weight:800}
    .order-sub{color:#64748b; font-size:13px}
    .order-total{padding:12px 16px; background:#f8fafc; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:18px}
    .order-actions{display:flex; gap:10px; padding:12px 16px; border-top:1px solid var(--border); background:#fff}
    .order-actions .btn{padding:8px 12px; border-radius:10px}
    .order-actions .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .order-actions .btn.ghost{background:#fff}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand" id="brandName">스토어</div>
      <nav class="toolbar">
        <button class="btn ghost" onclick="openMyPage()">마이페이지</button>
        <button class="btn primary" onclick="openCart()">장바구니(<span id="cartCount">0</span>)</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h2>상품 목록</h2>
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none">등록된 상품이 없습니다.</div>
    </section>
  </main>

  <!-- 장바구니 -->
  <aside class="drawer" id="cartDrawer" aria-hidden="true">
    <header>장바구니</header>
    <div class="body" id="cartBody"></div>
    <div class="foot">
      <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <strong>합계</strong><strong id="cartTotal">₩0</strong>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn ghost" onclick="clearCart()">비우기</button>
        <button class="btn primary" onclick="checkout()">주문 생성</button>
      </div>
    </div>
  </aside>

  <!-- 마이페이지(주문내역) -->
  <aside class="drawer" id="mypageDrawer" aria-hidden="true">
    <header>마이페이지 · 주문 내역</header>
    <div class="body" id="ordersWrap" style="padding-top:8px"></div>
    <div class="foot" style="display:flex;justify-content:flex-end">
      <button class="btn" onclick="closeMyPage()">닫기</button>
    </div>
  </aside>

  <footer>
    <div class="container footbar">
      <small id="bizInfo">사업자정보가 아직 등록되지 않았습니다.</small>
      <small>© <span id="year"></span></small>
    </div>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // ---- 공통 util
    document.getElementById('year').textContent = new Date().getFullYear();
    const fmt = n => '₩' + Number(n||0).toLocaleString('ko-KR');

    // ---- Firebase 설정 (당신 값)
    const firebaseConfig = {
      apiKey: "AIzaSyA3ZFVJIU7t01qhoXM6DLo-XK_30OdN9YE",
      authDomain: "payteacher-9da3a.firebaseapp.com",
      projectId: "payteacher-9da3a",
      storageBucket: "payteacher-9da3a.firebasestorage.app",
      messagingSenderId: "1048224861169",
      appId: "1:1048224861169:web:d6ce67ea15bb7ce7f0d250",
      measurementId: "G-PJDZZXDHEY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---- 상태
    let PRODUCTS = [];
    let cart = JSON.parse(localStorage.getItem('cart')||'[]');
    let orders = JSON.parse(localStorage.getItem('orders')||'[]');

    // ---- 설정(상호/사업자정보) 불러오기
    async function loadStoreConfig(){
      try{
        const doc = await db.collection('config').doc('store').get();
        const data = doc.exists ? doc.data() : {};
        document.getElementById('brandName').textContent = data.storeName || '득템생활연구소 스토어';
        document.getElementById('bizInfo').innerText = data.businessInfo || '사업자정보가 아직 등록되지 않았습니다.';
        document.title = (data.storeName || '스토어');
      }catch(e){ console.warn('config load error', e); }
    }

    // ---- 상품 불러오기
    async function fetchProducts(){
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');

      try {
        const snap = await db.collection('products').orderBy('createdAt','desc').get();
        PRODUCTS = [];
        snap.forEach(doc => PRODUCTS.push({id:doc.id, ...doc.data()}));

        // createdAt 없을 때도 보이게 보정 정렬
        PRODUCTS.sort((a,b)=>{
          const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime()
                   : (a.createdAt?.seconds ? a.createdAt.seconds*1000 : 0);
          const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime()
                   : (b.createdAt?.seconds ? b.createdAt.seconds*1000 : 0);
          return tb - ta;
        });

        if(PRODUCTS.length===0){ grid.innerHTML=''; empty.style.display='block'; return; }
        empty.style.display='none';
        grid.innerHTML = PRODUCTS.map(p=>`
          <article class="card">
            <div class="thumb">
              ${p.imageUrl?`<img src="${p.imageUrl}" alt="${p.name||''}">`:'<span style="opacity:.3">IMG</span>'}
              <div class="pill">${p.category||''}</div>
            </div>
            <div class="content">
              <h3 class="title">${p.name||''}</h3>
              <div style="color:var(--muted)">${p.specs||''}</div>
              <div class="price">${fmt(p.price)}</div>
              <button class="btn primary" onclick="addToCart('${p.id}')">장바구니 담기</button>
            </div>
          </article>
        `).join('');
      } catch (e) {
        console.error(e);
        empty.style.display='block';
        empty.textContent = `상품을 불러오지 못했습니다: ${e.message}`;
      }
    }

    // ---- 장바구니
    function openCart(){ document.getElementById('cartDrawer').classList.add('open'); renderCart(); }
    function closeCart(){ document.getElementById('cartDrawer').classList.remove('open'); }
    function addToCart(id){
      const item = cart.find(i=>i.id===id);
      if(item) item.qty++; else cart.push({id,qty:1});
      localStorage.setItem('cart',JSON.stringify(cart));
      renderCart();
      document.getElementById('cartCount').textContent = cart.reduce((s,i)=>s+i.qty,0);
      openCart();
    }
    function changeQty(id,delta){
      const item = cart.find(i=>i.id===id);
      if(!item) return;
      item.qty+=delta;
      if(item.qty<=0) cart=cart.filter(i=>i.id!==id);
      localStorage.setItem('cart',JSON.stringify(cart));
      renderCart();
      document.getElementById('cartCount').textContent = cart.reduce((s,i)=>s+i.qty,0);
    }
    function clearCart(){ cart=[]; localStorage.setItem('cart','[]'); renderCart(); document.getElementById('cartCount').textContent=0; }
    function renderCart(){
      const body = document.getElementById('cartBody');
      let total=0;
      if(cart.length===0){ body.innerHTML='<div class="empty">장바구니가 비었습니다.</div>'; document.getElementById('cartTotal').textContent=fmt(0); return; }
      body.innerHTML = cart.map(ci=>{
        const p = PRODUCTS.find(x=>x.id===ci.id);
        const line=(p?.price||0)*ci.qty; total+=line;
        return `<div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding:8px 0">
          <div>
            <div style="font-weight:700">${p?.name||'(삭제됨)'}</div>
            <div style="color:var(--muted);font-size:13px">${fmt(p?.price||0)} × ${ci.qty}</div>
          </div>
          <div>
            <button class="btn" onclick="changeQty('${ci.id}',-1)">-</button>
            <span>${ci.qty}</span>
            <button class="btn" onclick="changeQty('${ci.id}',1)">+</button>
          </div>
        </div>`;
      }).join('');
      document.getElementById('cartTotal').textContent=fmt(total);
    }

    // ---- 주문 생성 → Firestore + localStorage (이미지 포함)
    async function checkout(){
      if(cart.length===0){ alert('장바구니가 비었습니다.'); return; }
      const ts = new Date();
      const orderId = 'O'
        + ts.getFullYear()
        + String(ts.getMonth()+1).padStart(2,'0')
        + String(ts.getDate()).padStart(2,'0')
        + String(ts.getHours()).padStart(2,'0')
        + String(ts.getMinutes()).padStart(2,'0')
        + String(ts.getSeconds()).padStart(2,'0');

      const items = cart.map(ci=>{
        const p=PRODUCTS.find(x=>x.id===ci.id) || {};
        return {
          productId: p.id || ci.id,
          name: p.name || '(삭제됨)',
          qty: ci.qty,
          price: p.price || 0,
          imageUrl: p.imageUrl || ''
        };
      });
      const total = items.reduce((s,i)=>s+i.price*i.qty,0);

      try{
        await db.collection('orders').add({
          id: orderId, items, total,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }catch(e){
        console.error('주문 저장 오류:', e);
        alert('주문 저장 중 문제가 발생했습니다.');
        return;
      }

      const localOrder = { id: orderId, items, total, createdAt: ts.toISOString() };
      orders.unshift(localOrder);
      localStorage.setItem('orders', JSON.stringify(orders));
      cart=[]; localStorage.setItem('cart','[]');
      document.getElementById('cartCount').textContent=0;
      renderCart(); renderOrders(); closeCart();
      openMyPage();
      alert('주문이 생성되었습니다.');
    }

    // ---- 마이페이지(주문 내역) — 카드형 UI
    function openMyPage(){ document.getElementById('mypageDrawer').classList.add('open'); renderOrders(); }
    function closeMyPage(){ document.getElementById('mypageDrawer').classList.remove('open'); }

    // 날짜 라벨(YYYY.MM.DD(요일))
    function dateKorean(d){
      const dt = (typeof d === 'string') ? new Date(d) : d;
      const yo = ['일','월','화','수','목','금','토'][dt.getDay()];
      return `${dt.getFullYear()}.${String(dt.getMonth()+1).padStart(2,'0')}.${String(dt.getDate()).padStart(2,'0')}(${yo})`;
    }

    // 재구매 = 해당 주문 품목을 장바구니에 다시 담기
    function reorder(oid){
      const o = orders.find(x=>x.id===oid);
      if(!o) return;
      o.items.forEach(i=>{
        const ex = cart.find(c=>c.id===i.productId);
        if(ex) ex.qty += i.qty;
        else cart.push({ id: i.productId, qty: i.qty });
      });
      localStorage.setItem('cart', JSON.stringify(cart));
      document.getElementById('cartCount').textContent = cart.reduce((s,i)=>s+i.qty,0);
      openCart(); renderCart();
    }

    function renderOrders(){
      const wrap = document.getElementById('ordersWrap');
      if(!orders || orders.length===0){ wrap.innerHTML='<div class="empty">아직 주문이 없습니다.</div>'; return; }

      // 날짜별 그룹
      const groups = {};
      orders.forEach(o=>{
        const dt = new Date(o.createdAt);
        const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
        (groups[key] ||= []).push(o);
      });
      const dayKeys = Object.keys(groups).sort((a,b)=> b.localeCompare(a)); // 최신 먼저

      let html = '';
      for(const key of dayKeys){
        const list = groups[key];
        const [y,m,d] = key.split('-').map(Number);
        const label = dateKorean(new Date(y,m-1,d));
        html += `<div class="order-group">
          <div class="order-date">${label}</div>
          ${list.map(o=>{
            const timeStr = new Date(o.createdAt).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
            const totalQty = o.items.reduce((s,i)=>s+i.qty,0);
            return `
              <div class="order-card">
                <div class="order-head">
                  <div class="status">구매 확정</div>
                  <div class="order-no">${o.id}</div>
                </div>
                <div class="order-body">
                  ${o.items.map(i=>`
                    <div class="order-item">
                      <div class="order-thumb">
                        ${i.imageUrl ? `<img src="${i.imageUrl}" alt="">` : '<span style="opacity:.35">IMG</span>'}
                      </div>
                      <div>
                        <div class="order-title">${i.name || ''}</div>
                        <div class="order-sub">${fmt(i.price)} · ${i.qty}개</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
                <div class="order-total">
                  <div>주문시각&nbsp; ${timeStr}</div>
                  <div>총 수량&nbsp; <strong>${totalQty}</strong></div>
                  <div>합계&nbsp; <strong>${fmt(o.total)}</strong></div>
                </div>
                <div class="order-actions">
                  <button class="btn ghost" onclick="alert('구색용: 리뷰 작성은 미구현')">후기 작성</button>
                  <button class="btn ghost" onclick="alert('구색용: 배송 조회는 미구현')">배송 조회</button>
                  <button class="btn primary" onclick='reorder("${o.id}")'>재구매</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>`;
      }
      wrap.innerHTML = html;
    }

    // ---- 초기 (IIFE 비동기 초기화)
    document.getElementById('cartCount').textContent =
      (Array.isArray(cart) ? cart.reduce((s,i)=>s+i.qty,0) : 0);

    (async function init(){
      try { await loadStoreConfig(); } catch(e){ console.warn(e); }
      try { await fetchProducts(); }  catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>
